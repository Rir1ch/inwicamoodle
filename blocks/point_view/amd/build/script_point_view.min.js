define(["jquery","core/ajax","core/notification"],function(t,e,n){function a(e,n){var a=t("#module-"+e+" .block_point_view.reactions-container");return void 0===n?a:a.find(n)}var i={none:0,easy:1,better:2,hard:3},o={};function r(r,u,l,d){u.forEach(function(u){var m=parseInt(u.cmid),f=parseInt(u.uservote);if(o[m]=f,1===t("#module-"+m).length&&0===a(m).length){t("#module-"+m).prepend(l);var v=!1;a(m,".reaction img").click(function(){!1===v&&(v=!0,function(t,a,r){var c=i[r],u=o[a],l=c===u?i.none:c;return e.call([{methodname:"block_point_view_update_db",args:{func:"update",courseid:t,cmid:a,vote:l}}])[0].done(function(){if(o[a]=l,u!==i.none){var t=["","easy","better","hard"][u];s(a,t,-1,!1)}l!==i.none&&s(a,r,1,!0)}).fail(n.exception)}(r,m,t(this).data("reactionname")).always(function(){v=!1,c(m,d)}))}),a(m,".reactionnb").each(function(){var e=t(this).data("reactionname"),n=parseInt(u["total"+e]);s(m,e,n,f===i[e])}),c(m,d),function(e){var n=function(t){return{top:15-10*t,left:10-10*t,height:20*t}},i=function(t){return{left:10*t-10,height:20*t}},o=!1,r=null,c=null,s=function(){c=null,o=!1,function(e){["hard","better","easy"].forEach(function(i,o){var r=50+250*o;a(e,'.reaction img[data-reactionname="'+i+'"]').css({"pointer-events":"none"}).delay(r).animate(n(0),500),a(e,'.reactionnb[data-reactionname="'+i+'"]').delay(r).queue(function(e){t(this).addClass("invisible"),e()})}),a(e,".group_img").delay(500).show(0).animate(i(1),300).queue(function(t){a(e,".reactions").addClass("invisible"),t()}).css({"pointer-events":"auto"}),a(e,".group_nb").delay(600).show(0),t("#module-"+e+" .actions").delay(600).show(300)}(e)},u=function(){r=null,o=!0,function(e){a(e,".reactions").removeClass("invisible"),a(e,".group_img").css({"pointer-events":"none"}).animate(i(0),300).hide(0),a(e,".group_nb").delay(200).hide(300),t("#module-"+e+" .actions").delay(200).hide(300),["easy","better","hard"].forEach(function(i,o){var r=50+150*o;a(e,'.reaction img[data-reactionname="'+i+'"]').delay(r).animate(n(1),300).css({"pointer-events":"auto"}),a(e,'.reactionnb[data-reactionname="'+i+'"]').delay(r+300).queue(function(e){t(this).removeClass("invisible"),e()})})}(e),clearTimeout(c),c=setTimeout(s,2e3)};a(e,".group_img").mouseover(function(){t(this).stop().animate(i(1.15),100),r=setTimeout(u,300)}).mouseout(function(){o||(clearTimeout(r),t(this).stop().animate(i(1),100))}).click(u),a(e,".reaction img").mouseover(function(){t(this).stop().animate(n(2),100)}).mouseout(function(){t(this).stop().animate(n(1),100)}),a(e,".reactions").mouseout(function(){clearTimeout(c),c=setTimeout(s,1e3)}).mouseover(function(){clearTimeout(c)})}(m)}})}function c(e,n){var r="group_",c=0;a(e,".reactionnb").each(function(){var e=parseInt(t(this).text());e>0&&(r+=t(this).data("reactionname").toUpperCase().charAt(0)),c+=e}),a(e,".group_img").attr("src",n[r]);var s=a(e,".group_nb"),u=s.find("span");u.text(c).attr("title",M.util.get_string("totalreactions","block_point_view",c)),s.toggleClass("invisible",0===c).toggleClass("voted",o[e]!==i.none);var l=Math.min((""+c).length,5);u.css({right:Math.max(.25*(l-2),0)+"em",transform:"scaleX("+(1+.03*l*l-.35*l+.34)+")"})}function s(t,e,n,i){var o=a(t,'.reactionnb[data-reactionname="'+e+'"]'),r=parseInt(o.text())+n;o.text(r).toggleClass("nbselected",i),a(t,'.reaction img[data-reactionname="'+e+'"]').toggleClass("novote",0===r)}return{init:function(e){t(function(){var n,a=t(".block_point_view[data-blockdata]").data("blockdata");(n=function(){var n,i;n=a.difficultylevels,i=a.trackcolors,n.forEach(function(e){var n=parseInt(e.difficultyLevel),a="";if(n>0){var o=["greentrack","bluetrack","redtrack","blacktrack"][n-1];a=M.util.get_string(o,"block_point_view")}var r=t("<div>",{class:"block_point_view track",title:a,style:"background-color: "+i[n]+";"}),c=t("#module-"+e.id+" .mod-indent-outer");0===c.find(".block_point_view.track").length&&c.prepend(r),c.find(".mod-indent").after(r)}),r(e,a.moduleswithreactions,a.reactionstemplate,a.pix)})(),t(document).ajaxComplete(function(t,e,a){if(void 0!==a.data){var i=JSON.parse(a.data);i.length>0&&void 0!==i[0].methodname&&("format_tiles_get_single_section_page_html"!=i[0].methodname&&"format_tiles_log_tile_click"!=i[0].methodname||n())}}),t(".activity").mouseover(function(){t(this).css({background:"linear-gradient(to right, rgba(0,0,0,0.04), rgba(0,0,0,0.04), transparent)","border-radius":"5px"})}).mouseout(function(){t(this).css({background:""})})})}}});